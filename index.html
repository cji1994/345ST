import React, { useState, useEffect } from 'react';
import { Plus, Clock, User, CheckCircle, XCircle, Moon, Sun, Edit, Trash2, X, Save } from 'lucide-react';

export default function TaskTracker() {
  const [tasks, setTasks] = useState([]);
  const [filter, setFilter] = useState('all');
  const [watchFilter, setWatchFilter] = useState('all');
  const [loading, setLoading] = useState(true);
  const [darkMode, setDarkMode] = useState(false);
  const [selectedTask, setSelectedTask] = useState(null);
  const [editMode, setEditMode] = useState(false);
  const [formData, setFormData] = useState({
    type: 'Faults',
    watch: 'A',
    taskName: '',
    taskOwner: '',
    status: 'Ongoing',
    dateTime: '',
    comments: ''
  });

  // Load tasks and dark mode on mount
  useEffect(() => {
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
      .toISOString()
      .slice(0, 16);
    setFormData(prev => ({ ...prev, dateTime: localDateTime }));

    // Load tasks
    const savedTasks = localStorage.getItem('ctf345-tasks');
    if (savedTasks) setTasks(JSON.parse(savedTasks));

    // Load dark mode
    const savedDarkMode = localStorage.getItem('ctf345-darkmode');
    if (savedDarkMode) setDarkMode(JSON.parse(savedDarkMode));

    setLoading(false);
  }, []);

  // Save tasks
  const saveTasks = (newTasks) => {
    setTasks(newTasks);
    localStorage.setItem('ctf345-tasks', JSON.stringify(newTasks));
  };

  // Save dark mode
  const saveDarkMode = (mode) => {
    setDarkMode(mode);
    localStorage.setItem('ctf345-darkmode', JSON.stringify(mode));
  };

  const toggleDarkMode = () => saveDarkMode(!darkMode);

  const getNextRefNumber = () => {
    if (tasks.length === 0) return '001';
    const maxRef = Math.max(...tasks.map(t => parseInt(t.refNumber)));
    return String(maxRef + 1).padStart(3, '0');
  };

  const handleSubmit = () => {
    if (!formData.taskName || !formData.taskOwner || !formData.dateTime || !formData.comments) {
      alert('Please fill in all required fields');
      return;
    }

    const newTask = {
      ...formData,
      refNumber: getNextRefNumber(),
      id: Date.now()
    };

    const updatedTasks = [newTask, ...tasks];
    saveTasks(updatedTasks);

    setFormData({
      type: 'Faults',
      watch: 'A',
      taskName: '',
      taskOwner: '',
      status: 'Ongoing',
      dateTime: new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16),
      comments: ''
    });
  };

  const handleUpdate = () => {
    if (!selectedTask.taskName || !selectedTask.taskOwner || !selectedTask.dateTime || !selectedTask.comments) {
      alert('Please fill in all required fields');
      return;
    }

    const updatedTasks = tasks.map(task => task.id === selectedTask.id ? selectedTask : task);
    saveTasks(updatedTasks);
    setEditMode(false);
    alert('Task updated successfully!');
  };

  const handleDelete = (taskId) => {
    if (window.confirm('Are you sure you want to delete this task?')) {
      const updatedTasks = tasks.filter(task => task.id !== taskId);
      saveTasks(updatedTasks);
      setSelectedTask(null);
      setEditMode(false);
    }
  };

  const filteredTasks = tasks.filter(task => {
    const typeMatch = filter === 'all' ? true : task.type === filter;
    const watchMatch = watchFilter === 'all' ? true : task.watch === watchFilter;
    return typeMatch && watchMatch;
  });

  const getTypeColor = (type) => {
    if (darkMode) {
      switch(type) {
        case 'Faults': return 'bg-red-900 text-red-200 border-red-700';
        case 'Maintenance': return 'bg-blue-900 text-blue-200 border-blue-700';
        case 'Miscellaneous': return 'bg-gray-700 text-gray-200 border-gray-600';
        default: return 'bg-gray-700 text-gray-200';
      }
    } else {
      switch(type) {
        case 'Faults': return 'bg-red-100 text-red-800 border-red-300';
        case 'Maintenance': return 'bg-blue-100 text-blue-800 border-blue-300';
        case 'Miscellaneous': return 'bg-gray-100 text-gray-800 border-gray-300';
        default: return 'bg-gray-100 text-gray-800';
      }
    }
  };

  const bgClass = darkMode ? 'bg-gray-900' : 'bg-gray-50';
  const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
  const textPrimary = darkMode ? 'text-gray-100' : 'text-gray-900';
  const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
  const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
  const inputBg = darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-white border-gray-300 text-gray-900';
  const hoverBg = darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';

  return (
    <div className={`flex h-screen ${bgClass}`}>
      {/* Sidebar */}
      <div className={`w-80 ${cardBg} border-r ${borderColor} overflow-y-auto`}>
        {/* ...sidebar content (filters, dark mode toggle, task list) */}
        {/* Keep the JSX you already have here */}
      </div>

      {/* Main Content */}
      <div className="flex-1 overflow-y-auto">
        <div className="max-w-3xl mx-auto p-8">
          {/* ...main content (task details, edit form, new task form) */}
          {/* Keep your existing JSX here */}
        </div>
      </div>
    </div>
  );
}
